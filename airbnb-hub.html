<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta http-equiv="Cache-Control" content="no-cache, no-store, must-revalidate">
    <meta http-equiv="Pragma" content="no-cache">
    <meta http-equiv="Expires" content="0">
    <meta http-equiv="Content-Security-Policy" 
          content="default-src 'self'; 
                   connect-src 'self' https://*.firebaseio.com wss://*.firebaseio.com;
                   script-src 'self' 'unsafe-inline' https://www.gstatic.com https://cdnjs.cloudflare.com;
                   style-src 'self' 'unsafe-inline' https://cdnjs.cloudflare.com;
                   font-src 'self' https://cdnjs.cloudflare.com;
                   img-src 'self' data: blob: https:;">
    <title>Experiencia Airbnb - Recomendaciones</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-auth-compat.js"></script>
    <style>
        /* Estilos CSS de la primera parte (igual que en tu código original) */
        :root {
            --primary: #FF5A5F;
            --secondary: #008489;
            --light: #F7F9FA;
            --dark: #222222;
            --gray: #717171;
            --light-gray: #DDDDDD;
            --white: #FFFFFF;
            --success: #2e7d32;
            --warning: #ed6c02;
            --error: #d32f2f;
        }
        
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
        }
        
        body {
            background-color: var(--light);
            color: var(--dark);
            line-height: 1.6;
            overflow-x: hidden;
        }
        
        .container {
            max-width: 1000px;
            margin: 0 auto;
            padding: 20px;
        }
        
        /* ... (todos los demás estilos de la primera parte) ... */
    </style>
</head>
<body>
    <!-- Cache notification -->
    <div class="cache-notification hidden" id="cache-notification">
        <i class="fas fa-exclamation-triangle"></i>
        <span>Se detectó una versión antigua en caché</span>
        <button id="force-reload">Recargar ahora</button>
    </div>
    
    <div class="container">
        <!-- Header -->
        <div class="header">
            <h1 class="property-name" id="property-name">Casa de Montaña Tranquila</h1>
            <div class="property-location">
                <i class="fas fa-map-marker-alt"></i>
                <span id="property-location">Costa Rica</span>
            </div>
            
            <div class="share-section">
                <p class="share-text">¡Recomienda esta propiedad en tus redes sociales!</p>
                <div class="social-links">
                    <a href="#" class="social-link facebook" id="share-facebook">
                        <i class="fab fa-facebook-f"></i>
                    </a>
                    <a href="#" class="social-link twitter" id="share-twitter">
                        <i class="fab fa-twitter"></i>
                    </a>
                    <a href="#" class="social-link instagram" id="share-instagram">
                        <i class="fab fa-instagram"></i>
                    </a>
                    <a href="#" class="social-link whatsapp" id="share-whatsapp">
                        <i class="fab fa-whatsapp"></i>
                    </a>
                    <a href="#" class="social-link airbnb" id="share-airbnb">
                        <i class="fab fa-airbnb"></i>
                    </a>
                </div>
            </div>
        </div>
        
        <!-- Tabs -->
        <div class="tabs">
            <div class="tab active" data-tab="recommendations">Recomendaciones</div>
            <div class="tab" data-tab="local-guide">Guía Local</div>
            <div class="tab" data-tab="feedback">Feedback</div>
            <div class="tab" data-tab="host">Acceso Anfitrión</div>
        </div>
        
        <!-- Tab Content -->
        <div id="recommendations-content" class="tab-content active">
            <!-- Host Recommendations -->
            <div id="host-recommendations">
                <h2 class="section-title">
                    <i class="fas fa-crown"></i>
                    Recomendaciones del Anfitrión
                </h2>
                <div class="cards-container" id="host-recommendations-container">
                    <!-- Las recomendaciones del anfitrión se cargarán aquí con Firebase -->
                </div>
            </div>
            
            <!-- Guest Recommendations -->
            <div id="guest-recommendations">
                <h2 class="section-title">
                    <i class="fas fa-users"></i>
                    Recomendaciones de Huéspedes
                </h2>
                <div class="cards-container" id="guest-recommendations-container">
                    <!-- Las recomendaciones de huéspedes se cargarán aquí con Firebase -->
                </div>
            </div>
            
            <!-- Add Recommendation Form -->
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-plus-circle"></i>
                    Añade tu Recomendación
                </h2>
                <form id="recommendation-form">
                    <div class="form-group">
                        <label for="recommendation-title" class="form-label">Título</label>
                        <input type="text" id="recommendation-title" class="form-input" placeholder="Nombre del lugar o actividad" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="guest-name" class="form-label">Tu Nombre</label>
                        <input type="text" id="guest-name" class="form-input" placeholder="Cómo quieres que aparezca tu nombre" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="recommendation-category" class="form-label">Categoría</label>
                        <select id="recommendation-category" class="form-select" required>
                            <option value="">Selecciona una categoría</option>
                            <option value="food">Comida y Bebidas</option>
                            <option value="nature">Naturaleza</option>
                            <option value="adventure">Aventura</option>
                            <option value="culture">Cultura</option>
                            <option value="shopping">Compras</option>
                            <option value="other">Otro</option>
                        </select>
                    </div>
                    
                    <div class="form-group">
                        <label for="recommendation-rating" class="form-label">Calificación (1-5)</label>
                        <div class="rating" id="rating-stars">
                            <i class="far fa-star star" data-value="1"></i>
                            <i class="far fa-star star" data-value="2"></i>
                            <i class="far fa-star star" data-value="3"></i>
                            <i class="far fa-star star" data-value="4"></i>
                            <i class="far fa-star star" data-value="5"></i>
                        </div>
                        <input type="hidden" id="recommendation-rating" value="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="recommendation-description" class="form-label">Descripción</label>
                        <textarea id="recommendation-description" class="form-textarea" placeholder="Describe tu experiencia y por qué lo recomiendas..." required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-large">
                        <i class="fas fa-paper-plane"></i>
                        Enviar Recomendación
                    </button>
                </form>
            </div>
        </div>
        
        <!-- Local Guide Tab -->
        <div id="local-guide-content" class="tab-content">
            <h2 class="section-title">
                <i class="fas fa-map-marked-alt"></i>
                Guía Local - Lugares Recomendados
            </h2>
            
            <div class="cards-container" id="local-guide-container">
                <!-- Los elementos de la guía local se cargarán aquí con Firebase -->
            </div>
        </div>
        
        <!-- Feedback Tab -->
        <div id="feedback-content" class="tab-content">
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-comment-dots"></i>
                    Envíanos tu Feedback
                </h2>
                <form id="feedback-form">
                    <div class="form-group">
                        <label for="feedback-name" class="form-label">Tu Nombre</label>
                        <input type="text" id="feedback-name" class="form-input" placeholder="Nombre o alias" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-email" class="form-label">Email (opcional)</label>
                        <input type="email" id="feedback-email" class="form-input" placeholder="Si quieres que te contactemos">
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-rating" class="form-label">Califica tu experiencia</label>
                        <div class="rating" id="feedback-rating-stars">
                            <i class="far fa-star star" data-value="1"></i>
                            <i class="far fa-star star" data-value="2"></i>
                            <i class="far fa-star star" data-value="3"></i>
                            <i class="far fa-star star" data-value="4"></i>
                            <i class="far fa-star star" data-value="5"></i>
                        </div>
                        <input type="hidden" id="feedback-rating" value="0" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="feedback-message" class="form-label">Tu Mensaje</label>
                        <textarea id="feedback-message" class="form-textarea" placeholder="¿Qué te gustó? ¿Qué podemos mejorar?" required></textarea>
                    </div>
                    
                    <button type="submit" class="btn btn-large">
                        <i class="fas fa-share-square"></i>
                        Enviar Feedback
                    </button>
                </form>
            </div>
            
            <h2 class="section-title">
                <i class="fas fa-history"></i>
                Historial de Feedback
            </h2>
            <div class="cards-container" id="feedback-container">
                <!-- Los elementos de feedback se cargarán aquí con Firebase -->
            </div>
        </div>
        
        <!-- Host Tab -->
        <div id="host-content" class="tab-content">
            <div class="form-container">
                <h2 class="form-title">
                    <i class="fas fa-user-shield"></i>
                    Acceso Anfitrión
                </h2>
                <form id="host-login-form">
                    <div class="form-group">
                        <label for="host-email" class="form-label">Usuario</label>
                        <input type="text" id="host-username" class="form-input" placeholder="admin" required>
                    </div>
                    
                    <div class="form-group">
                        <label for="host-password" class="form-label">Contraseña</label>
                        <input type="password" id="host-password" class="form-input" placeholder="admin123" required>
                    </div>
                    
                    <button type="submit" class="btn btn-large">
                        <i class="fas fa-sign-in-alt"></i>
                        Iniciar Sesión
                    </button>
                </form>
            </div>
            
            <div id="host-dashboard" class="hidden">
                <div class="host-indicator">
                    <i class="fas fa-crown"></i>
                    Modo Anfitrión Activo
                </div>
                
                <h2 class="section-title">
                    <i class="fas fa-tools"></i>
                    Panel de Control
                </h2>
                
                <div class="cards-container">
                    <div class="card">
                        <h3 class="card-title">Gestionar Recomendaciones</h3>
                        <p class="card-content">
                            Añade, edita o elimina recomendaciones del anfitrión y gestiona las recomendaciones enviadas por huéspedes.
                        </p>
                        <button class="btn btn-secondary" id="manage-recommendations" style="margin-top: 15px;">
                            <i class="fas fa-edit"></i>
                            Gestionar
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Actualizar Guía Local</h3>
                        <p class="card-content">
                            Mantén actualizada la guía local con nuevos lugares o elimina información que ya no sea relevante.
                        </p>
                        <button class="btn btn-secondary" id="update-guide" style="margin-top: 15px;">
                            <i class="fas fa-map-marked-alt"></i>
                            Actualizar Guía
                        </button>
                    </div>
                    
                    <div class="card">
                        <h3 class="card-title">Ver Feedback</h3>
                        <p class="card-content">
                            Revisa todos los comentarios y calificaciones que los huéspedes han enviado sobre su experiencia.
                        </p>
                        <button class="btn btn-secondary" id="view-feedback" style="margin-top: 15px;">
                            <i class="fas fa-comments"></i>
                            Ver Comentarios
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Toast -->
        <div class="toast" id="toast">
            <i class="fas fa-check-circle"></i>
            <span id="toast-message">¡Operación exitosa!</span>
        </div>
        
        <!-- Loading Spinner -->
        <div class="spinner" id="loading-spinner"></div>
    </div>
    
    <!-- Footer -->
    <footer class="app-footer">
        <div class="footer-links">
            <a href="#" class="footer-link">Términos y Condiciones</a>
            <a href="#" class="footer-link">Política de Privacidad</a>
            <a href="#" class="footer-link">Soporte</a>
        </div>
        <p>© 2023 Experiencia Airbnb. Todos los derechos reservados.</p>
        <p>Versión 2.0 | Última actualización: <span id="current-date"></span></p>
    </footer>
    
    <script>
        // ===== SOLUCIÓN PARA EL CACHÉ =====
        // Comprobar si la página está cargando una versión antigua
        if (performance.navigation.type === 1) {
            const params = new URLSearchParams(window.location.search);
            params.set('_', Date.now());
            window.location.search = params.toString();
        }
        
        // Mostrar notificación de caché
        document.getElementById('force-reload').addEventListener('click', function() {
            window.location.reload(true); // Recarga forzada sin caché
        });
        
        // Mostrar fecha actual en el footer
        const now = new Date();
        document.getElementById('current-date').textContent = 
            `${now.getDate()}/${now.getMonth() + 1}/${now.getFullYear()}`;
      
        // ===== CONFIGURACIÓN FIREBASE =====
        const firebaseConfig = {
            apiKey: "AIzaSyDyPNn1142JA7l2nOP2QNm0uOmQhq3qMXs",
            authDomain: "basedatosllaves.firebaseapp.com",
            databaseURL: "https://basedatosllaves-default-rtdb.firebaseio.com",
            projectId: "basedatosllaves",
            storageBucket: "basedatosllaves.appspot.com",
            messagingSenderId: "234616763395",
            appId: "1:234616763395:web:2e9977d7d7e4d601dd4a36"
        };

        // Inicializar Firebase
        firebase.initializeApp(firebaseConfig);
        const database = firebase.database();
        
        // Obtener parámetros de la URL
        const urlParams = new URLSearchParams(window.location.search);
        const country = urlParams.get('country') || 'costa-rica';
        const propertyId = urlParams.get('properties') || 'prop_default';
        
        // Validar parámetros
        if (!country || !propertyId) {
            console.error("Parámetros de URL incompletos:", {country, propertyId});
            showToast("Error: Faltan parámetros en la URL", "error");
            document.getElementById('property-name').textContent = "Error en la URL";
            document.getElementById('property-location').textContent = "Faltan parámetros";
        } else {
            // Mostrar notificación si se detecta caché
            document.getElementById('cache-notification').classList.remove('hidden');
        }
        
        // Referencias a Firebase
        const propertyRef = database.ref(`properties/${country}/${propertyId}/propertyData`);
        const hostRecommendationsRef = database.ref(`properties/${country}/${propertyId}/hostRecommendations`);
        const guestRecommendationsRef = database.ref(`properties/${country}/${propertyId}/guestRecommendations`);
        const localGuideRef = database.ref(`properties/${country}/${propertyId}/localGuide`);
        const feedbackRef = database.ref(`properties/${country}/${propertyId}/feedback`);
        
        // Estado de autenticación
        let isHost = localStorage.getItem('isHost') === 'true' || false;
        
        // Mostrar spinner de carga
        function showSpinner() {
            document.getElementById('loading-spinner').style.display = 'block';
        }
        
        // Ocultar spinner de carga
        function hideSpinner() {
            document.getElementById('loading-spinner').style.display = 'none';
        }
        
        // Función corregida para cargar datos de propiedad
        function loadPropertyData() {
            showSpinner();
            
            propertyRef.once('value').then(snapshot => {
                if (snapshot.exists()) {
                    const propertyData = snapshot.val();
                    document.getElementById('property-name').textContent = propertyData.name || 'Casa de Montaña Tranquila';
                    
                    // Mostrar país desde parámetro URL (convertido a formato amigable)
                    const countryDisplay = country.replace(/-/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
                    document.getElementById('property-location').textContent = countryDisplay;
                } else {
                    document.getElementById('property-location').textContent = "Ubicación no disponible";
                    console.error("Datos de propiedad no encontrados");
                    showToast("Propiedad no encontrada", "warning");
                }
                hideSpinner();
            }).catch(error => {
                console.error("Error cargando datos de propiedad:", error);
                hideSpinner();
                showToast("Error cargando propiedad", "error");
            });
        }

        // Función genérica para cargar recomendaciones
        function loadRecommendations(ref, containerId, isHostRec = false) {
            showSpinner();
            const container = document.getElementById(containerId);
            container.innerHTML = '';
            
            ref.on('value', snapshot => {
                container.innerHTML = '';
                const recommendations = snapshot.val();
                
                if (!recommendations) {
                    container.innerHTML = '<p class="no-data">No hay recomendaciones disponibles</p>';
                    hideSpinner();
                    return;
                }

                // Convertir a array si es objeto
                const recArray = Array.isArray(recommendations) ? 
                    recommendations : 
                    Object.keys(recommendations).map(key => ({ ...recommendations[key], id: key }));
                
                recArray.forEach((rec, index) => {
                    if (!rec) return;
                    
                    const stars = Array(5).fill().map((_, i) => 
                        `<i class="fas fa-star ${i < (rec.rating || 0) ? 'filled' : ''}"></i>`
                    ).join('');
                    
                    const card = `
                        <div class="card ${isHostRec ? 'host-recommendation' : ''} fade-in">
                            ${isHost ? `<button class="edit-btn delete-recommendation" data-type="${isHostRec ? 'host' : 'guest'}" data-id="${rec.id || index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : ''}
                            <div class="card-header">
                                <div class="avatar">${isHostRec ? 'A' : (rec.guestName || 'H').charAt(0)}</div>
                                <div>
                                    <h3 class="card-title">${rec.title || 'Sin título'}</h3>
                                    <p class="card-subtitle">
                                        <i class="${isHostRec ? 'fas fa-map-marker-alt' : 'fas fa-user'}"></i>
                                        ${isHostRec ? (rec.location || 'Ubicación desconocida') : 
                                         `${rec.guestName || 'Anónimo'} - ${formatDate(rec.date)}`}
                                    </p>
                                </div>
                            </div>
                            <div class="rating">
                                ${stars}
                            </div>
                            <p class="card-content">
                                ${rec.description || 'Sin descripción'}
                            </p>
                            <span class="category-tag">${getCategoryName(rec.category)}</span>
                        </div>
                    `;
                    container.innerHTML += card;
                });
                
                // Agregar event listeners para botones de eliminación
                document.querySelectorAll('.delete-recommendation').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const type = this.getAttribute('data-type');
                        const id = this.getAttribute('data-id');
                        deleteRecommendation(type, id);
                    });
                });
                
                hideSpinner();
            }, error => {
                console.error(`Error cargando recomendaciones:`, error);
                hideSpinner();
                showToast("Error cargando recomendaciones", "error");
            });
        }

        // Funciones específicas para cargar recomendaciones
        function loadHostRecommendations() {
            loadRecommendations(hostRecommendationsRef, 'host-recommendations-container', true);
        }

        function loadGuestRecommendations() {
            loadRecommendations(guestRecommendationsRef, 'guest-recommendations-container');
        }

        // Función para cargar la guía local
        function loadLocalGuide() {
            showSpinner();
            const container = document.getElementById('local-guide-container');
            container.innerHTML = '';
            
            localGuideRef.on('value', snapshot => {
                container.innerHTML = '';
                const guideItems = snapshot.val();
                
                if (!guideItems) {
                    container.innerHTML = '<p class="no-data">No hay elementos en la guía local</p>';
                    hideSpinner();
                    return;
                }

                // Convertir a array si es objeto
                const guideArray = Array.isArray(guideItems) ? 
                    guideItems : 
                    Object.keys(guideItems).map(key => ({ ...guideItems[key], id: key }));
                
                guideArray.forEach((item, index) => {
                    if (!item) return;
                    
                    const card = `
                        <div class="card fade-in">
                            ${isHost ? `<button class="edit-btn delete-guide-item" data-id="${item.id || index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : ''}
                            <div class="card-header">
                                <div class="avatar">G</div>
                                <div>
                                    <h3 class="card-title">${item.title || 'Sin título'}</h3>
                                    <p class="card-subtitle">
                                        <i class="${item.icon || 'fas fa-map-marker-alt'}"></i>
                                        ${item.location || 'Ubicación desconocida'}
                                    </p>
                                </div>
                            </div>
                            <p class="card-content">
                                ${item.description || 'Sin descripción'}
                            </p>
                            <span class="category-tag">${getCategoryName(item.category)}</span>
                        </div>
                    `;
                    container.innerHTML += card;
                });
                
                // Agregar event listeners para botones de eliminación
                document.querySelectorAll('.delete-guide-item').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteGuideItem(id);
                    });
                });
                
                hideSpinner();
            }, error => {
                console.error("Error cargando guía local:", error);
                hideSpinner();
                showToast("Error cargando guía local", "error");
            });
        }

        // Función para cargar feedback
        function loadFeedback() {
            showSpinner();
            const container = document.getElementById('feedback-container');
            container.innerHTML = '';
            
            feedbackRef.on('value', snapshot => {
                container.innerHTML = '';
                const feedbacks = snapshot.val();
                
                if (!feedbacks) {
                    container.innerHTML = '<p class="no-data">No hay feedback disponible</p>';
                    hideSpinner();
                    return;
                }

                // Convertir a array si es objeto
                const feedbackArray = Array.isArray(feedbacks) ? 
                    feedbacks : 
                    Object.keys(feedbacks).map(key => ({ ...feedbacks[key], id: key }));
                
                feedbackArray.forEach((fb, index) => {
                    if (!fb) return;
                    
                    const stars = Array(5).fill().map((_, i) => 
                        `<i class="fas fa-star ${i < (fb.rating || 0) ? 'filled' : ''}"></i>`
                    ).join('');
                    
                    const card = `
                        <div class="card fade-in">
                            ${isHost ? `<button class="edit-btn delete-feedback" data-id="${fb.id || index}">
                                <i class="fas fa-trash-alt"></i>
                            </button>` : ''}
                            <div class="card-header">
                                <div class="avatar">${(fb.name || 'A').charAt(0)}</div>
                                <div>
                                    <h3 class="card-title">${fb.name || 'Anónimo'}</h3>
                                    <p class="card-subtitle">
                                        <i class="far fa-calendar"></i>
                                        ${formatDate(fb.date)}
                                    </p>
                                </div>
                            </div>
                            <div class="rating">
                                ${stars}
                            </div>
                            <p class="card-content">
                                ${fb.message || 'Sin mensaje'}
                            </p>
                        </div>
                    `;
                    container.innerHTML += card;
                });
                
                // Agregar event listeners para botones de eliminación
                document.querySelectorAll('.delete-feedback').forEach(btn => {
                    btn.addEventListener('click', function() {
                        const id = this.getAttribute('data-id');
                        deleteFeedback(id);
                    });
                });
                
                hideSpinner();
            }, error => {
                console.error("Error cargando feedback:", error);
                hideSpinner();
                showToast("Error cargando feedback", "error");
            });
        }

        // Función para eliminar recomendaciones
        function deleteRecommendation(type, id) {
            const ref = type === 'host' ? hostRecommendationsRef : guestRecommendationsRef;
            
            if (typeof id === 'string') {
                // Eliminar por ID específico
                ref.child(id).remove()
                    .then(() => showToast('Recomendación eliminada'))
                    .catch(error => {
                        console.error("Error eliminando recomendación:", error);
                        showToast('Error eliminando recomendación', 'error');
                    });
            } else {
                // Manejo para arrays (backward compatibility)
                ref.once('value').then(snapshot => {
                    let recommendations = snapshot.val();
                    
                    if (!recommendations) {
                        showToast('No hay recomendaciones para eliminar', 'warning');
                        return;
                    }
                    
                    // Convertir a array si es objeto
                    const recArray = Array.isArray(recommendations) ? 
                        recommendations : 
                        Object.keys(recommendations).map(key => recommendations[key]);
                    
                    if (id >= 0 && id < recArray.length) {
                        recArray.splice(id, 1);
                        
                        // Firebase necesita un objeto si originalmente lo era
                        const updatedData = Array.isArray(recommendations) ? recArray : 
                            recArray.reduce((obj, item, i) => ({...obj, [i]: item}), {});
                        
                        ref.set(updatedData)
                            .then(() => showToast('Recomendación eliminada'))
                            .catch(error => {
                                console.error("Error eliminando recomendación:", error);
                                showToast('Error eliminando recomendación', 'error');
                            });
                    } else {
                        showToast('Índice de recomendación inválido', 'error');
                    }
                }).catch(error => {
                    console.error("Error obteniendo recomendaciones:", error);
                    showToast('Error eliminando recomendación', 'error');
                });
            }
        }

        // Función para eliminar elementos de la guía
        function deleteGuideItem(id) {
            if (typeof id === 'string') {
                localGuideRef.child(id).remove()
                    .then(() => showToast('Elemento eliminado de la guía'))
                    .catch(error => {
                        console.error("Error eliminando elemento:", error);
                        showToast('Error eliminando elemento', 'error');
                    });
            } else {
                localGuideRef.once('value').then(snapshot => {
                    const guideItems = snapshot.val() || [];
                    if (Array.isArray(guideItems)) {
                        guideItems.splice(id, 1);
                        localGuideRef.set(guideItems)
                            .then(() => showToast('Elemento eliminado de la guía'))
                            .catch(error => {
                                console.error("Error eliminando elemento:", error);
                                showToast('Error eliminando elemento', 'error');
                            });
                    }
                });
            }
        }

        // Función para eliminar feedback
        function deleteFeedback(id) {
            if (typeof id === 'string') {
                feedbackRef.child(id).remove()
                    .then(() => showToast('Feedback eliminado'))
                    .catch(error => {
                        console.error("Error eliminando feedback:", error);
                        showToast('Error eliminando feedback', 'error');
                    });
            } else {
                feedbackRef.once('value').then(snapshot => {
                    const feedbacks = snapshot.val() || [];
                    if (Array.isArray(feedbacks)) {
                        feedbacks.splice(id, 1);
                        feedbackRef.set(feedbacks)
                            .then(() => showToast('Feedback eliminado'))
                            .catch(error => {
                                console.error("Error eliminando feedback:", error);
                                showToast('Error eliminando feedback', 'error');
                            });
                    }
                });
            }
        }

        // Obtener nombre de categoría
        function getCategoryName(category) {
            const categories = {
                'food': 'Comida',
                'nature': 'Naturaleza',
                'adventure': 'Aventura',
                'culture': 'Cultura',
                'shopping': 'Compras',
                'other': 'Otro'
            };
            return categories[category] || 'General';
        }
        
        // Formatear fecha
        function formatDate(timestamp) {
            if (!timestamp) return 'Fecha desconocida';
            try {
                const date = new Date(typeof timestamp === 'number' ? timestamp : timestamp);
                return date.toLocaleDateString('es-ES', { 
                    year: 'numeric', 
                    month: 'long', 
                    day: 'numeric' 
                });
            } catch (e) {
                return 'Fecha inválida';
            }
        }
        
        // Mostrar notificación toast
        function showToast(message, type = 'success') {
            const toast = document.getElementById('toast');
            const toastMessage = document.getElementById('toast-message');
            
            toastMessage.textContent = message;
            toast.className = 'toast';
            
            if (type === 'error') {
                toast.style.backgroundColor = 'var(--error)';
            } else if (type === 'warning') {
                toast.style.backgroundColor = 'var(--warning)';
            } else {
                toast.style.backgroundColor = 'var(--success)';
            }
            
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, 3000);
        }
        
        // Inicializar página
        function initPage() {
            try {
                if (!country || !propertyId) {
                    throw new Error("Faltan parámetros en la URL");
                }
                
                loadPropertyData();
                loadHostRecommendations();
                loadGuestRecommendations();
                loadLocalGuide();
                loadFeedback();
                
                // Verificar si estamos en modo anfitrión desde localStorage
                if (isHost) {
                    document.getElementById('host-dashboard').classList.remove('hidden');
                }
            } catch (error) {
                console.error("Error inicializando página:", error);
                showToast("Error al cargar la página", "error");
            }
        }

        // ===== EVENT LISTENERS =====
        document.addEventListener('DOMContentLoaded', function() {
            // Tab functionality
            document.querySelectorAll('.tab').forEach(tab => {
                tab.addEventListener('click', function() {
                    // Remove active class from all tabs and content
                    document.querySelectorAll('.tab').forEach(t => t.classList.remove('active'));
                    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
                    
                    // Add active class to clicked tab
                    this.classList.add('active');
                    
                    // Show corresponding content
                    const tabId = this.getAttribute('data-tab');
                    document.getElementById(`${tabId}-content`).classList.add('active');
                });
            });
            
            // Star rating functionality
            function setupRating(containerId, inputId) {
                const stars = document.querySelectorAll(`#${containerId} .star`);
                const ratingInput = document.getElementById(inputId);
                
                stars.forEach(star => {
                    star.addEventListener('click', function() {
                        const value = parseInt(this.getAttribute('data-value'));
                        ratingInput.value = value;
                        
                        stars.forEach((s, index) => {
                            if (index < value) {
                                s.classList.remove('far');
                                s.classList.add('fas', 'filled');
                            } else {
                                s.classList.remove('fas', 'filled');
                                s.classList.add('far');
                            }
                        });
                    });
                    
                    star.addEventListener('mouseover', function() {
                        const value = parseInt(this.getAttribute('data-value'));
                        
                        stars.forEach((s, index) => {
                            if (index < value && !s.classList.contains('filled')) {
                                s.classList.add('hover');
                            }
                        });
                    });
                    
                    star.addEventListener('mouseout', function() {
                        stars.forEach(s => s.classList.remove('hover'));
                    });
                });
            }
            
            // Initialize ratings
            setupRating('rating-stars', 'recommendation-rating');
            setupRating('feedback-rating-stars', 'feedback-rating');
            
            // Form submissions
            document.getElementById('recommendation-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const title = document.getElementById('recommendation-title').value.trim();
                const guestName = document.getElementById('guest-name').value.trim();
                const category = document.getElementById('recommendation-category').value;
                const rating = parseInt(document.getElementById('recommendation-rating').value);
                const description = document.getElementById('recommendation-description').value.trim();
                
                if (!title || !guestName || !category || !description) {
                    showToast('Por favor, completa todos los campos', 'warning');
                    return;
                }
                
                if (rating === 0) {
                    showToast('Por favor, califica tu recomendación', 'warning');
                    return;
                }
                
                // Crear objeto de recomendación
                const recommendation = {
                    title,
                    guestName,
                    category,
                    rating,
                    description,
                    date: new Date().getTime()
                };
                
                // Guardar en Firebase
                guestRecommendationsRef.push(recommendation)
                    .then(() => {
                        showToast('¡Gracias por tu recomendación!');
                        this.reset();
                        
                        // Reset stars
                        document.querySelectorAll('#rating-stars .star').forEach(star => {
                            star.classList.remove('fas', 'filled');
                            star.classList.add('far');
                        });
                        document.getElementById('recommendation-rating').value = 0;
                    })
                    .catch(error => {
                        console.error("Error enviando recomendación:", error);
                        showToast('Error enviando recomendación', 'error');
                    });
            });
            
            document.getElementById('feedback-form').addEventListener('submit', function(e) {
                e.preventDefault();
                
                const name = document.getElementById('feedback-name').value.trim();
                const email = document.getElementById('feedback-email').value.trim();
                const rating = parseInt(document.getElementById('feedback-rating').value);
                const message = document.getElementById('feedback-message').value.trim();
                
                if (!name || !message) {
                    showToast('Por favor, completa los campos requeridos', 'warning');
                    return;
                }
                
                if (rating === 0) {
                    showToast('Por favor, califica tu experiencia', 'warning');
                    return;
                }
                
                // Crear objeto de feedback
                const feedback = {
                    name,
                    email: email || null,
                    rating,
                    message,
                    date: new Date().getTime()
                };
                
                // Guardar en Firebase
                feedbackRef.push(feedback)
                    .then(() => {
                        showToast('¡Feedback enviado correctamente!');
                        this.reset();
                        
                        // Reset stars
                        document.querySelectorAll('#feedback-rating-stars .star').forEach(star => {
                            star.classList.remove('fas', 'filled');
                            star.classList.add('far');
                        });
                        document.getElementById('feedback-rating').value = 0;
                    })
                    .catch(error => {
                        console.error("Error enviando feedback:", error);
                        showToast('Error enviando feedback', 'error');
                    });
            });
            
            document.getElementById('host-login-form').addEventListener('submit', function(e) {
                e.preventDefault();
                const username = document.getElementById('host-username').value.trim();
                const password = document.getElementById('host-password').value.trim();
                
                // Validar credenciales (en producción usar Firebase Auth)
                if (username === 'admin' && password === 'admin123') {
                    isHost = true;
                    localStorage.setItem('isHost', 'true');
                    document.getElementById('host-dashboard').classList.remove('hidden');
                    showToast('Sesión iniciada como anfitrión');
                    
                    // Recargar datos en modo anfitrión
                    loadHostRecommendations();
                    loadGuestRecommendations();
                    loadLocalGuide();
                    loadFeedback();
                } else {
                    showToast('Credenciales incorrectas', 'error');
                }
            });
            
            // Botones del panel de anfitrión
            document.getElementById('manage-recommendations').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="recommendations"]').click();
            });
            
            document.getElementById('update-guide').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="local-guide"]').click();
            });
            
            document.getElementById('view-feedback').addEventListener('click', function() {
                document.querySelector('.tab[data-tab="feedback"]').click();
            });
            
            // Social sharing (simulado)
            document.getElementById('share-facebook').addEventListener('click', function(e) {
                e.preventDefault();
                showToast('Compartiendo en Facebook...');
            });
            
            document.getElementById('share-twitter').addEventListener('click', function(e) {
                e.preventDefault();
                showToast('Compartiendo en Twitter...');
            });
            
            document.getElementById('share-instagram').addEventListener('click', function(e) {
                e.preventDefault();
                showToast('Compartiendo en Instagram...');
            });
            
            document.getElementById('share-whatsapp').addEventListener('click', function(e) {
                e.preventDefault();
                showToast('Compartiendo en WhatsApp...');
            });
            
            document.getElementById('share-airbnb').addEventListener('click', function(e) {
                e.preventDefault();
                showToast('Compartiendo en Airbnb...');
            });
            
            // Animation on scroll
            const observerOptions = {
                root: null,
                rootMargin: '0px',
                threshold: 0.1
            };
            
            const observer = new IntersectionObserver((entries) => {
                entries.forEach(entry => {
                    if (entry.isIntersecting) {
                        entry.target.classList.add('fade-in');
                        observer.unobserve(entry.target);
                    }
                });
            }, observerOptions);
            
            // Observe all cards for animation
            document.querySelectorAll('.card').forEach(card => {
                observer.observe(card);
            });
            
            // Inicializar la página con datos de Firebase
            initPage();
        });
    </script>
</body>
</html>